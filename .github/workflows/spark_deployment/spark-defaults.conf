# Catalog and Core Configuration
spark.sql.warehouse.dir                        s3a://dbt-spark-iceberg/github-integration-testing
spark.sql.catalog.glue                         org.apache.iceberg.spark.SparkCatalog
spark.sql.catalog.glue.catalog-impl            org.apache.iceberg.aws.glue.GlueCatalog
spark.sql.catalog.glue.warehouse               s3a://dbt-spark-iceberg/github-integration-testing
spark.sql.catalog.glue.io-impl                 org.apache.iceberg.aws.s3.S3FileIO
spark.sql.defaultCatalog                       glue
spark.sql.catalog.glue.database                dbt-spark-iceberg

# Table capabilities and operation settings
spark.sql.catalog.glue.table-default.format-version 2
spark.sql.catalog.glue.table-default.write.update.mode merge-on-read
spark.sql.catalog.glue.table-default.write.delete.mode merge-on-read
spark.sql.catalog.glue.table-default.write.merge.mode merge-on-read
spark.sql.catalog.glue.table-default.write.distribution-mode hash
spark.sql.catalog.glue.table-default.write.data.path s3a://dbt-spark-iceberg/github-integration-testing
spark.sql.catalog.glue.table-default.write.metadata.path s3a://dbt-spark-iceberg/github-integration-testing/metadata
spark.sql.catalog.glue.table-default.write.metadata.previous-versions-max 10
spark.sql.catalog.glue.table-default.write.format.default iceberg
spark.sql.catalog.glue.table-default.engine.hive.enabled true
spark.sql.table.is.transactional true

# Iceberg Specific Configurations
spark.sql.iceberg.check-nullability false
spark.sql.iceberg.vectorization.enabled true
spark.sql.iceberg.handle-timestamp-without-timezone true
spark.sql.extensions                           org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions

# Merge Operation Optimizations
spark.sql.iceberg.merge.mode merge-on-read
spark.sql.iceberg.merge.cardinality.check.enabled false
spark.sql.optimizer.dynamicPartitionPruning.enabled true
spark.sql.optimizer.decorrelate.subquery.enabled true
spark.sql.optimizer.join.reorder.enabled true
spark.sql.optimizer.runtime.bloomFilter.enabled true

# Merge Performance Tuning
spark.sql.shuffle.partitions                   200
spark.sql.adaptive.shuffle.targetPostShuffleInputSize 128M
spark.sql.adaptive.advisoryPartitionSizeInBytes 128M
spark.sql.adaptive.coalescePartitions.initialPartitionNum 200
spark.sql.adaptive.coalescePartitions.minPartitionNum 50

# Memory Configuration for Merge Operations
spark.memory.fraction                          0.85
spark.memory.storageFraction                   0.3
spark.sql.shuffle.spill.diskMerge.enabled     true
spark.sql.shuffle.spill.numElementsForceSpillThreshold 5000

# Additional Merge Optimizations
spark.sql.autoBroadcastJoinThreshold          100M
spark.sql.adaptive.localShuffleReader.enabled  true
spark.sql.adaptive.skewJoin.enabled           true
spark.sql.adaptive.nonEmptyPartitionRatioForBroadcastJoin 0.2
spark.sql.adaptive.coalescePartitions.enabled  true

# Maintain your existing performance, network, and S3 configurations...
spark.master                                   local[3]
spark.driver.memory                            10g
spark.executor.memory                          3g
spark.driver.maxResultSize                     2g
spark.default.parallelism                      6

# Network Resilience (keep existing...)
spark.network.timeout                          800s
spark.executor.heartbeatInterval              100s
spark.storage.blockManagerSlaveTimeoutMs      300s
spark.rpc.io.maxRetries                       10

# S3/AWS Configuration (keep existing...)
spark.hadoop.fs.s3a.connection.timeout         300000
spark.hadoop.fs.s3a.connection.maximum         200
spark.hadoop.fs.s3a.attempts.maximum           20

# Error Recovery and Resilience (keep existing...)
spark.task.maxFailures                        8
spark.speculation                             true
spark.speculation.multiplier                  3

# Thrift Server Configuration (keep existing...)
spark.sql.hive.thriftServer.async             true
spark.sql.hive.thriftServer.maxWorkerThreads  6
spark.sql.hive.thriftServer.minWorkerThreads  4